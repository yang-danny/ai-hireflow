services:
   # MongoDB Database
   mongodb:
      image: mongo:8.0-noble
      container_name: ai-hireflow-mongodb
      restart: unless-stopped
      environment:
         MONGO_INITDB_ROOT_USERNAME: admin
         MONGO_INITDB_ROOT_PASSWORD: admin123
         MONGO_INITDB_DATABASE: ai-hireflow
      ports:
         - '27017:27017'
      volumes:
         - mongodb_data:/data/db
         - mongodb_config:/data/configdb
      networks:
         - ai-hireflow-network
      healthcheck:
         test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
         interval: 10s
         timeout: 10s
         retries: 5
         start_period: 40s

   # Redis Cache
   redis:
      image: redis:7.4-alpine
      container_name: ai-hireflow-redis
      restart: unless-stopped
      command: redis-server --appendonly yes --requirepass redis123
      ports:
         - '6379:6379'
      volumes:
         - redis_data:/data
      networks:
         - ai-hireflow-network
      healthcheck:
         test: ['CMD', 'redis-cli', '--raw', 'incr', 'ping']
         interval: 10s
         timeout: 5s
         retries: 5
         start_period: 30s

   # Backend API Server
   server:
      build:
         context: .
         dockerfile: ./packages/server/Dockerfile
      container_name: ai-hireflow-server
      restart: unless-stopped
      ports:
         - '3000:3000'
      environment:
         # Server Configuration
         NODE_ENV: production
         PORT: 3000
         HOST: 0.0.0.0

         # Database
         MONGODB_URI: mongodb://admin:admin123@mongodb:27017/ai-hireflow?authSource=admin

         # Redis
         REDIS_URL: redis://:redis123@redis:6379

         # JWT & Authentication
         JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-this-in-production}
         JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
         COOKIE_SECRET: ${COOKIE_SECRET:-your-super-secret-cookie-key-change-this-in-production}

         # Google OAuth
         GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
         GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
         GOOGLE_REDIRECT_URI: ${GOOGLE_REDIRECT_URI:-http://localhost:3000/api/auth/google/callback}

         # CORS Configuration
         ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:3001,http://localhost:3000}
         FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3001}

         # Error Tracking (Sentry)
         SENTRY_DSN: ${SENTRY_DSN}
         SERVER_NAME: ${SERVER_NAME:-ai-hireflow-api}

         # Logging
         LOG_LEVEL: ${LOG_LEVEL:-info}
      volumes:
         - server_logs:/app/packages/server/logs
         - server_uploads:/app/packages/server/uploads
      networks:
         - ai-hireflow-network
      depends_on:
         mongodb:
            condition: service_healthy
         redis:
            condition: service_healthy
      healthcheck:
         test:
            [
               'CMD',
               'node',
               '-e',
               "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
            ]
         interval: 30s
         timeout: 10s
         retries: 3
         start_period: 60s

   # Frontend Client
   client:
      build:
         context: .
         dockerfile: ./packages/client/Dockerfile
      container_name: ai-hireflow-client
      restart: unless-stopped
      ports:
         - '3001:3001'
      environment:
         # API Configuration
         VITE_API_URL: ${VITE_API_URL:-http://localhost:3000}

         # AI Configuration (Gemini)
         VITE_GEMINI_API_KEY: ${VITE_GEMINI_API_KEY}

         # Error Tracking (Sentry)
         VITE_SENTRY_DSN: ${VITE_SENTRY_DSN}
      networks:
         - ai-hireflow-network
      depends_on:
         server:
            condition: service_healthy

# Named volumes for data persistence
volumes:
   mongodb_data:
      driver: local
   mongodb_config:
      driver: local
   redis_data:
      driver: local
   server_logs:
      driver: local
   server_uploads:
      driver: local

# Custom network for service communication
networks:
   ai-hireflow-network:
      driver: bridge
