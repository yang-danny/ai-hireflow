name: CI

on:
   push:
      branches: [main, master]
   pull_request:
      branches: [main, master]

jobs:
   test:
      runs-on: ubuntu-latest

      services:
         mongodb:
            image: mongo:7
            ports:
               - 27017:27017

      steps:
         - uses: actions/checkout@v4

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
              node-version: '24'
              cache: 'npm'

         - name: Install dependencies
           run: npm ci

         - name: Lint
           run: npm run lint

         - name: Type Check
           run: npm run typecheck

         - name: Run Unit Tests
           run: npm run test --workspaces --if-present

         - name: Build
           run: npm run build

         - name: Cache Playwright browsers
           uses: actions/cache@v4
           with:
              path: ~/.cache/ms-playwright
              key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
              restore-keys: |
                 ${{ runner.os }}-playwright-

         - name: Install Playwright Browsers
           run: npx playwright install --with-deps

         - name: Run E2E Tests
           run: |
              npm run dev &
              npx wait-on http://localhost:5173 -t 60000
              npx playwright test
           env:
              CI: true
              NODE_ENV: test
              MONGODB_URI: mongodb://localhost:27017/ai-hireflow
              JWT_SECRET: ci-test-secret-key-must-be-long-enough
              COOKIE_SECRET: ci-test-cookie-secret-key-must-be-long-enough
              GOOGLE_CLIENT_ID: ci-test-google-client-id
              GOOGLE_CLIENT_SECRET: ci-test-google-client-secret

   security-audit:
      runs-on: ubuntu-latest
      steps:
         - uses: actions/checkout@v4

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
              node-version: '24'
              cache: 'npm'

         - name: Run Security Audit
           run: npm audit
